---
title: 微服务
tags: [Hexo, Fluid]
index_img: /img/default.jpeg
date: 2019-10-10 10:00:00
---

## 一、微服务简介

微服务架构的系统是个**分布式系统**，按业务领域划分为**独立的服务单元**，有自动化运维、容错、快速演进的特点，它能够解决传统单体架构系统的痛点，同时也能满足越来越复杂的业务需求。

### 单体架构的不足

- 业务越来越复杂，单体应用的代码量越来越大。
- 用户越来越多，程序承受的并发越来越高，单体应用的并发能力有限。
- 测试的难度越来越大，单体应用的业务都在同个程序中，随着业务的扩张、复杂度的增加，单体应用修改业务或者增加业务或许会给其他业务带来一定影响，导致测试难度增加。

### 微服务概念

就是将一个大的应用，拆分成多个小模块，每个模块都有自己的功能和职责，每个模块可以进行交互。

### 微服务特点

- 按业务划分为一个独立运行的程序，即服务单元
- 服务之间通过HTTP协议相互通信
- 自动化部署
- 可以用不同的编程语言
- 可以用不同的存储技术
- 服务集中化管理
- 微服务是一个分布式系统

### 微服务不足

- 微服务的复杂度
- 分布式事务问题
- 服务的划分（按照功能划分 还是按照组件划分）
- 服务的部署（自动化部署）

## 二、SpringCloud

SpringCloud是微服务的解决方案，首要目标就是通过提供一系列开发组件，帮助开发者迅速搭建一个分布式的微服务系统。

### SpringCloud版本对应关系

每个SpringCloud版本要使用自身所适配的各组件对应版本（自行搭配各组件版本不保证可用）

### SpringCloud常用组件表

- 服务的注册和发现：eureka（netflix公司），nacos（阿里巴巴），consul（Spring官方）
- 服务的负载均衡：ribbon，dubbo
- 服务的相互调用：openFeign，dubbo
- 服务的容错：hystrix，sentinel
- 服务网关：gateway，zuul
- 服务配置的统一管理：config-server，nacos，apollo
- 服务消息总线：bus
- 服务安全组件：security，Oauth2.0
- 服务监控：admin，jvm
- 链路追踪：sleuth+zipkin

## 三、Eureka（注册发现中心）

### 1. 简介

Eureka是Netflix在线影片公司开源的一个服务注册与发现的组件。

### 2. Spring Cloud Eureka 和 Zookeeper 的区别

#### 2.1 什么是CAP原则？

在分布式 为服务里面 CAP定理

CAP原则又称CAP定理，指的是在一个分布式系统中

- 一致性（Consistency）：集群中多个服务器的数据是一致的。

- 可用性（Availability）：当有一个节点挂掉了，整个集群可以继续对外提供服务。

- 分区容错性（Partition tolerance）：由于机房网络或者分区等原因，会导致各个机器中的数据短暂不一致。



***三者不可兼得，但P必须存在。***

CP：数据是一致的，但如果有个节点挂了，整个服务在几分钟之内不能提供服务

AP：数据可能不一致

#### 2.2 分布式特征

ZK遵循CP原则，服务会短暂停止，重新选举一个节点出来。

eureka注重AP，高可用。只要有一个机器存活，就能继续对外服务。

### 3. Spring Cloud 其他注册中心

#### 3.1 Consul

#### 3.2 Nacos

## 4. Spring Cloud 快速入门

#### 注册中心

1. 在注册中心里面需要一个服务列表（容器）保存应用的信息
2. 应用下线了或者挂了，服务列表需要中立
3. 主动下线 怎么处理？
4. 被动下线 怎么处理？注册中心将你剔除。
5. 缓存在本地的服务列表脏读怎么办？能否容忍脏读问题？
6. 如果在一个时间段内 大量的应用都不和你联系了 该怎么办？

​		eureka-server不会剔除任何一个服务（宁可放过一万，不能错杀一个）



应用和注册中心需要建立联系 - 建立心跳机制：每次心跳就是一个请求

#### 集群的深入理解

- 如果是主从模式，主机该怎么选择？

- 如果是主从模式，数据是怎么同步的？

​		分布式数据一致性协议：Paxos，raft

​		https://thesecretlivesofdata.com/raft/

### Eureka概念

#### 1. 服务注册

当项目启动时（eureka的客户端），就会向eureka-server发送自己的**元数据（原始数据）**（运行的ip，端口port，健康的状态监控等，因为使用的是http/Restful请求风格），eureka-server会在自己的内部保留这些元数据（内存中）。（有一个服务列表）（restful风格，以http动词的请求方式，完成对url资源的操作）

#### 2. 服务续约

项目启动成功了，除 了向eureka-server注册自己成功，还会**定时**向eureka-server汇报自己，心跳，表示自己还活着。（修改一个时间）

#### 3. 服务下线（主动下线）

当项目关闭时，会给eureka-server报告，说明自己要下机了。

#### 4. 服务的剔除（被动下线，主动剔除）

当项目超过了指定时间没有向eureka-server汇报自己，那么eureka-server就会认为此节点死掉了，会把他剔除掉，也不会放流量和请求到此节点了。

### Eureka源码

#### 1. Eureka运作原理的特点

**Eureka-server对外提供的是restful风格的服务。**

**http服务 + 特定的请求方式 + 特定的url地址**



